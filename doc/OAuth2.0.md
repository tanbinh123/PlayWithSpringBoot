# OAuth

开放授权（OAuth）是一个开放标准，允许用户让第三方应用访问该用户在某一网站上的私密的资源，而无需将用户名和密码提供给第三方应用。

OAuth 允许用户提供一个 Token，而不是用户名和密码来访问他们存放在特定服务提供者的数据。每一个令牌授权一个特定的网站（例如，视频编辑网站)在特定的时段（例如，接下来的 2 小时内）内访问特定的资源（例如仅仅是某一相册中的视频）。  

> OAuth 引入了一个授权层，用来分离两种不同的角色：客户端和资源所有者。......资源所有者同意以后，资源服务器可以向客户端颁发令牌。客户端通过令牌，去请求数据。
>
> 这段话的意思就是，**OAuth 的核心就是向第三方应用颁发令牌。**



## OAuth 2.0 规定了四种获得令牌的流程

- 授权码（authorization-code）
- 隐藏式（implicit）
- 密码式（password）：
- 客户端凭证（client credentials）



> 注意：不管是哪一种授权方式，第三方应用需要提前在系统中备案获取：客户端 ID（Client ID）和密钥（Client Secret）

Web 应用中最常见的是授权码（authorization-code）这种方式，安全性也最高

## OAuth 定义了四个角色

- 资源所有者（Resource Owner）
- 资源服务器（Resource Server）
- 客户（Client）
- 授权服务器（Authorization Server）

## 协议流程

```
     +--------+                               +---------------+
     |        |--(A)- Authorization Request ->|   Resource    |
     |        |                               |     Owner     |
     |        |<-(B)-- Authorization Grant ---|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(C)-- Authorization Grant -->| Authorization |
     | Client |                               |     Server    |
     |        |<-(D)----- Access Token -------|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(E)----- Access Token ------>|    Resource   |
     |        |                               |     Server    |
     |        |<-(F)--- Protected Resource ---|               |
     +--------+                               +---------------+
```
（A）客户端请求资源所有者的授权。该授权请求可以直接向资源拥有者（如图所示），或者最好间接通过授权服务器作为中介。

（B）客户端收到授权授予，该授权授予是表示资源所有者授权的凭据，使用本规范中定义的四种授权类型之一或扩展授权类型表示。该
    授权许可类型取决于所使用的方法的客户端，以请求授权和由所述支持的类型授权服务器。

（C）客户端通过与授权服务器进行身份验证并提供授权授权来请求访问令牌。

（D）授权服务器对客户端进行身份验证并验证授权授权，如果有效，则颁发访问令牌。

## 刷新一个过期的令牌

```
  +--------+                                           +---------------+
  |        |--(A)------- Authorization Grant --------->|               |
  |        |                                           |               |
  |        |<-(B)----------- Access Token -------------|               |
  |        |               & Refresh Token             |               |
  |        |                                           |               |
  |        |                            +----------+   |               |
  |        |--(C)---- Access Token ---->|          |   |               |
  |        |                            |          |   |               |
  |        |<-(D)- Protected Resource --| Resource |   | Authorization |
  | Client |                            |  Server  |   |     Server    |
  |        |--(E)---- Access Token ---->|          |   |               |
  |        |                            |          |   |               |
  |        |<-(F)- Invalid Token Error -|          |   |               |
  |        |                            +----------+   |               |
  |        |                                           |               |
  |        |--(G)----------- Refresh Token ----------->|               |
  |        |                                           |               |
  |        |<-(H)----------- Access Token -------------|               |
  +--------+           & Optional Refresh Token        +---------------+
```

（A）客户端通过与授权服务器进行身份验证并提供授权授权来请求访问令牌。

（B）授权服务器对客户端进行身份验证并验证授权授权，如果有效，则颁发访问令牌和刷新令牌。

（C）客户端通过提供访问令牌向资源服务器发出受保护的资源请求。

（D）资源服务器验证访问令牌，如果有效，则服务该请求。

（E）重复步骤（C）和（D），直到访问令牌过期。如果客户端知道访问令牌已过期，则跳至步骤（G）;
    否则，它将发出另一个受保护的资源请求。

（F）由于访问令牌无效，因此资源服务器返回无效令牌错误。

（G）客户端通过与授权服务器进行身份验证并提供刷新令牌来请求新的访问令牌。该客户端身份验证的要求是基于客户端类型
    和授权服务器策略。

（H）授权服务器对客户端进行身份验证并验证刷新令牌，如果有效，则颁发新的访问令牌（以及可选的新的刷新令牌）。



# ref

- <http://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html> 
- <https://oauth.net/2/> 

